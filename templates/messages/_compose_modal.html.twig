{# Compose Message Modal - Can be included on any page #}
{# Usage: {% include 'messages/_compose_modal.html.twig' with {'recipientId': user.id, 'recipientName': user.username} %} #}

<div id="compose-message-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-hidden">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-envelope text-yellow-600 mr-2"></i>
                Send Message to {{ recipientName|default('User') }}
            </h3>
            <button
                type="button"
                onclick="closeComposeModal()"
                class="text-gray-400 hover:text-gray-600 transition"
            >
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="compose-message-form" class="p-6">
            <input type="hidden" name="receiver_id" value="{{ recipientId }}">

            <div class="mb-4">
                <label for="compose-message-content" class="block text-sm font-medium text-gray-700 mb-2">
                    Message
                </label>
                <textarea
                    id="compose-message-content"
                    name="content"
                    rows="6"
                    placeholder="Type your message here..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent resize-none"
                    required
                ></textarea>
                <p class="mt-1 text-sm text-gray-500">
                    Be respectful and follow our community guidelines
                </p>
            </div>

            <div class="flex items-center justify-end space-x-3">
                <button
                    type="button"
                    onclick="closeComposeModal()"
                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition"
                >
                    Cancel
                </button>
                <button
                    type="submit"
                    class="px-6 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-lg transition flex items-center"
                >
                    <i class="fas fa-paper-plane mr-2"></i>
                    Send Message
                </button>
            </div>
        </form>

        <!-- Success/Error Messages -->
        <div id="compose-message-status" class="hidden p-4 border-t border-gray-200">
            <div id="compose-message-success" class="hidden p-3 bg-green-50 text-green-800 rounded-lg text-sm">
                <i class="fas fa-check-circle mr-2"></i>
                Message sent successfully!
            </div>
            <div id="compose-message-error" class="hidden p-3 bg-red-50 text-red-800 rounded-lg text-sm">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="compose-message-error-text">Failed to send message</span>
            </div>
        </div>
    </div>
</div>

<script>
    // Open modal function
    function openComposeModal(recipientId, recipientName) {
        const modal = document.getElementById('compose-message-modal');
        const form = document.getElementById('compose-message-form');
        const receiverInput = form.querySelector('[name="receiver_id"]');
        const modalTitle = modal.querySelector('h3');

        receiverInput.value = recipientId;
        if (recipientName) {
            modalTitle.innerHTML = `<i class="fas fa-envelope text-yellow-600 mr-2"></i>Send Message to ${recipientName}`;
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    // Close modal function
    function closeComposeModal() {
        const modal = document.getElementById('compose-message-modal');
        const form = document.getElementById('compose-message-form');

        modal.classList.add('hidden');
        modal.classList.remove('flex');
        document.body.style.overflow = 'auto';

        // Reset form and status messages
        form.reset();
        document.getElementById('compose-message-status').classList.add('hidden');
        document.getElementById('compose-message-success').classList.add('hidden');
        document.getElementById('compose-message-error').classList.add('hidden');
    }

    // Handle form submission
    {% if recipientId is defined %}
    document.getElementById('compose-message-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitButton = this.querySelector('[type="submit"]');
        const statusDiv = document.getElementById('compose-message-status');
        const successDiv = document.getElementById('compose-message-success');
        const errorDiv = document.getElementById('compose-message-error');
        const errorText = document.getElementById('compose-message-error-text');

        // Disable submit button
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

        try {
            const response = await fetch('{{ path('app_messages_send') }}', {
                method: 'POST',
                body: formData
            });

            statusDiv.classList.remove('hidden');

            if (response.ok) {
                // Show success message
                successDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');

                // Reset form
                this.reset();

                // Redirect to conversation after 1 second
                setTimeout(function() {
                    window.location.href = '{{ path('app_messages_conversation', {userId: recipientId}) }}';
                }, 1000);
            } else {
                const error = await response.json();
                errorText.textContent = error.error || 'Failed to send message';
                errorDiv.classList.remove('hidden');
                successDiv.classList.add('hidden');

                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Message';
            }
        } catch (error) {
            console.error('Error:', error);
            errorText.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('hidden');
            successDiv.classList.add('hidden');

            // Re-enable submit button
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Message';
        }
    });
    {% endif %}

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeComposeModal();
        }
    });

    // Close modal on backdrop click
    document.getElementById('compose-message-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeComposeModal();
        }
    });
</script>
