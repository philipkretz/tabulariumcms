{% extends 'base.html.twig' %}

{% block title %}{{ 'profile.preview'|trans|default('Profile Preview') }} - {{ parent() }}{% endblock %}

{% block body %}
<!-- Preview Banner -->
<div class="bg-yellow-500 text-white py-3 px-4 sticky top-0 z-50 shadow-lg">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
        <div class="flex items-center">
            <i class="fas fa-eye mr-2"></i>
            <span class="font-semibold">{{ 'profile.preview_mode'|trans|default('Preview Mode') }}</span>
            <span class="ml-2 text-yellow-100 hidden sm:inline">{{ 'profile.preview_hint'|trans|default('This is how others will see your profile') }}</span>
        </div>
        <div class="flex gap-3">
            <a href="{{ path('app_profile_edit') }}" class="px-4 py-2 bg-white text-yellow-600 rounded-lg hover:bg-gray-100 transition font-medium text-sm">
                <i class="fas fa-edit mr-1"></i>{{ 'common.edit'|trans|default('Edit') }}
            </a>
            {% if profile and (profile.profileSlug or targetUser.username) %}
                <a href="{{ path('app_public_profile', {slug: profile.profileSlug ?? targetUser.username}) }}" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition font-medium text-sm">
                    <i class="fas fa-external-link-alt mr-1"></i>{{ 'profile.view_public'|trans|default('View Public') }}
                </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="min-h-screen bg-gray-50">
    {# Cover Photo Section #}
    <div class="relative h-64 bg-gradient-to-br from-yellow-400 to-yellow-600">
        {% if profile and profile.coverPhoto %}
            <img src="{{ asset('uploads/profiles/' ~ targetUser.id ~ '/' ~ profile.coverPhoto) }}" alt="Cover Photo" class="w-full h-full object-cover">
        {% endif %}
    </div>

    {# Profile Header #}
    <div class="max-w-6xl mx-auto px-4 -mt-20">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex flex-col md:flex-row gap-6">
                {# Avatar #}
                <div class="flex-shrink-0">
                    {% if profile and profile.avatar %}
                        <img src="{{ asset('uploads/profiles/' ~ targetUser.id ~ '/' ~ profile.avatar) }}" alt="{{ targetUser.fullName }}" class="w-32 h-32 rounded-full border-4 border-white shadow-lg">
                    {% else %}
                        {% set initials = targetUser.firstName|slice(0, 1)|upper ~ targetUser.lastName|slice(0, 1)|upper %}
                        <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-white text-3xl font-bold">
                            {{ initials }}
                        </div>
                    {% endif %}
                </div>

                {# Profile Info #}
                <div class="flex-grow">
                    <h1 class="text-3xl font-bold text-gray-900">{{ targetUser.fullName }}</h1>

                    {% if profile and profile.tagline %}
                        <p class="text-lg text-gray-600 mt-1">{{ profile.tagline }}</p>
                    {% endif %}

                    <div class="flex flex-wrap gap-4 mt-4 text-gray-600">
                        {% if profile and profile.location %}
                            <div class="flex items-center">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                {{ profile.location }}
                            </div>
                        {% endif %}

                        {% if profile and profile.website %}
                            <div class="flex items-center">
                                <i class="fas fa-globe mr-2"></i>
                                <a href="{{ profile.website }}" target="_blank" rel="noopener" class="text-yellow-600 hover:underline">
                                    {{ profile.website|replace({'https://': '', 'http://': '', 'www.': ''}) }}
                                </a>
                            </div>
                        {% endif %}

                        <div class="flex items-center">
                            <i class="fas fa-calendar mr-2"></i>
                            {{ 'profile.joined'|trans|default('Joined') }} {{ targetUser.createdAt|date('F Y') }}
                        </div>

                        {% if profile %}
                            <div class="flex items-center">
                                <i class="fas fa-eye mr-2"></i>
                                {{ profile.profileViews }} {{ 'profile.views'|trans|default('views') }}
                            </div>
                        {% endif %}
                    </div>

                    {# Social Links #}
                    {% if profile and profile.socialLinks and profile.socialLinks|length > 0 %}
                        <div class="flex gap-3 mt-4">
                            {% for platform, url in profile.socialLinks %}
                                {% if platform != 'custom' and url %}
                                    <a href="{{ url }}" target="_blank" rel="noopener" class="text-gray-600 hover:text-gray-900 transition" title="{{ platform|capitalize }}">
                                        <i class="fab fa-{{ platform }} text-2xl"></i>
                                    </a>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                {# Stats #}
                <div class="flex md:flex-col gap-4 text-center">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-gray-900">{{ friendCount }}</div>
                        <div class="text-sm text-gray-600">{{ 'profile.friends'|trans|default('Friends') }}</div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-2xl font-bold text-gray-900">{{ recentMedia|length }}</div>
                        <div class="text-sm text-gray-600">{{ 'profile.media'|trans|default('Media') }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Main Content #}
    <div class="max-w-6xl mx-auto px-4 mt-6 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {# Left Column - About & Content #}
            <div class="lg:col-span-2 space-y-6">
                {# About Section with Custom HTML/CSS #}
                {% if profile and profile.bio %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">{{ 'profile.about'|trans|default('About') }}</h2>
                        {# Custom CSS (scoped to bio-content) #}
                        {% if profile.customTemplate %}
                            <style>.bio-content { {{ profile.customTemplate|raw }} }</style>
                        {% endif %}
                        {# Bio content rendered as HTML #}
                        <div class="bio-content text-gray-700">{{ profile.bio|raw }}</div>
                    </div>
                {% endif %}

                {# Looking For #}
                {% if profile and profile.lookingFor %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-search text-yellow-600 mr-2"></i>
                            {{ 'profile.looking_for'|trans|default('I am looking for') }}
                        </h2>
                        <div class="text-gray-700 whitespace-pre-line">{{ profile.lookingFor|raw }}</div>
                    </div>
                {% endif %}

                {# What I Offer #}
                {% if profile and profile.offering %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">
                            <i class="fas fa-gift text-yellow-600 mr-2"></i>
                            {{ 'profile.offering'|trans|default('What I offer') }}
                        </h2>
                        <div class="text-gray-700 whitespace-pre-line">{{ profile.offering|raw }}</div>
                    </div>
                {% endif %}

                {# Interests #}
                {% if profile and profile.interests and profile.interests|length > 0 %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">{{ 'profile.interests'|trans|default('Interests') }}</h2>
                        <div class="flex flex-wrap gap-2">
                            {% for interest in profile.interests %}
                                <span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-sm">
                                    {{ interest }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {# Recent Media #}
                {% if recentMedia|length > 0 %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-900">{{ 'profile.recent_media'|trans|default('Recent Media') }}</h2>
                            <a href="{{ path('app_profile_media_gallery') }}" class="text-yellow-600 hover:underline text-sm">
                                {{ 'profile.manage_gallery'|trans|default('Manage Gallery') }}
                            </a>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            {% for media in recentMedia %}
                                <div class="relative aspect-square rounded-lg overflow-hidden group">
                                    {% if media.type == 'image' %}
                                        <img src="{{ asset('uploads/user-media/' ~ targetUser.id ~ '/' ~ media.filename) }}" alt="{{ media.originalFilename }}" class="w-full h-full object-cover">
                                    {% elseif media.type == 'video' %}
                                        <video src="{{ asset('uploads/user-media/' ~ targetUser.id ~ '/' ~ media.filename) }}" class="w-full h-full object-cover"></video>
                                        <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30">
                                            <i class="fas fa-play-circle text-white text-4xl"></i>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-900">{{ 'profile.media'|trans|default('Media') }}</h2>
                        </div>
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-images text-4xl mb-3"></i>
                            <p>{{ 'profile.no_media'|trans|default('No media uploaded yet') }}</p>
                            <a href="{{ path('app_profile_media_gallery') }}" class="inline-block mt-3 text-yellow-600 hover:underline">
                                {{ 'profile.upload_media'|trans|default('Upload media') }}
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>

            {# Right Column - Friends #}
            <div class="space-y-6">
                {# Friends Section #}
                {% if friends|length > 0 %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-bold text-gray-900">{{ 'profile.friends'|trans|default('Friends') }}</h2>
                            <span class="text-gray-600 text-sm">{{ friendCount }} {{ 'common.total'|trans|default('total') }}</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            {% for friend in friends %}
                                <div class="text-center">
                                    {% if friend.profile and friend.profile.avatar %}
                                        <img src="{{ asset('uploads/profiles/' ~ friend.id ~ '/' ~ friend.profile.avatar) }}" alt="{{ friend.fullName }}" class="w-16 h-16 rounded-full mx-auto">
                                    {% else %}
                                        {% set friendInitials = friend.firstName|slice(0, 1)|upper ~ friend.lastName|slice(0, 1)|upper %}
                                        <div class="w-16 h-16 rounded-full mx-auto bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white text-sm font-bold">
                                            {{ friendInitials }}
                                        </div>
                                    {% endif %}
                                    <div class="text-xs text-gray-700 mt-1 truncate">{{ friend.firstName }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="bg-white rounded-xl shadow p-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-4">{{ 'profile.friends'|trans|default('Friends') }}</h2>
                        <p class="text-gray-500 text-center py-4">{{ 'profile.no_friends'|trans|default('No friends yet') }}</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
