{% extends 'base.html.twig' %}

{% block title %}{{ 'profile.media_gallery'|trans }} - {{ parent() }}{% endblock %}

{% block body %}
<!-- Include Navigation -->
{% include 'components/navigation.html.twig' %}

<!-- Cookie Banner -->
{% include 'components/cookie_banner.html.twig' %}

<div class="min-h-screen bg-gradient-to-b from-gray-50 to-white py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {% include 'profile/_navigation.html.twig' %}

        {% for type, messages in app.flashes %}
            {% for message in messages %}
                <div class="mb-6 rounded-lg p-4 {{ type == 'success' ? 'bg-green-50 border border-green-200 text-green-800' : 'bg-red-50 border border-red-200 text-red-800' }}">
                    <div class="flex items-center">
                        <i class="fas {{ type == 'success' ? 'fa-check-circle' : 'fa-exclamation-circle' }} mr-2"></i>
                        {{ message }}
                    </div>
                </div>
            {% endfor %}
        {% endfor %}

        <div class="bg-white rounded-lg shadow-lg p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-images mr-3 text-yellow-600"></i>
                        {{ 'profile.media_gallery'|trans }}
                    </h2>
                    <p class="text-gray-600 mt-1">
                        {{ currentMediaCount }} / {{ maxMediaPerUser }} {{ 'profile.files_per_user'|trans }}
                        <span class="text-gray-400">{{ 'profile.max_file_size_info'|trans({'%size%': (maxMediaSizeKb / 1024)|round(1)}) }}</span>
                    </p>
                </div>

                {% if currentMediaCount < maxMediaPerUser %}
                    <label class="px-6 py-3 bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-700 hover:to-yellow-600 text-white font-semibold rounded-lg transition shadow-lg cursor-pointer">
                        <i class="fas fa-upload mr-2"></i>{{ 'profile.upload_media_button'|trans }}
                        <input type="file" id="media-upload" accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/webm" multiple class="hidden">
                    </label>
                {% else %}
                    <div class="px-6 py-3 bg-gray-200 text-gray-500 font-semibold rounded-lg cursor-not-allowed">
                        <i class="fas fa-ban mr-2"></i>{{ 'profile.gallery_full'|trans }}
                    </div>
                {% endif %}
            </div>

            <!-- Upload Progress -->
            <div id="upload-progress" class="hidden mb-6">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-yellow-600 mr-3"></i>
                        <span class="text-yellow-800">{{ 'profile.uploading'|trans }}</span>
                    </div>
                    <div class="mt-2 bg-yellow-200 rounded-full h-2">
                        <div id="upload-bar" class="bg-yellow-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="upload-error" class="hidden mb-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        <span id="error-message" class="text-red-800"></span>
                    </div>
                </div>
            </div>

            <!-- Media Grid -->
            {% if media|length > 0 %}
                <div id="media-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    {% for item in media %}
                        <div class="media-item relative group aspect-square rounded-lg overflow-hidden bg-gray-100" data-id="{{ item.id }}">
                            {% if item.type == 'image' %}
                                <img src="{{ asset('uploads/user-media/' ~ user.id ~ '/' ~ item.filename) }}"
                                     alt="{{ item.originalFilename }}"
                                     class="w-full h-full object-cover">
                            {% elseif item.type == 'video' %}
                                <video src="{{ asset('uploads/user-media/' ~ user.id ~ '/' ~ item.filename) }}"
                                       class="w-full h-full object-cover"></video>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <i class="fas fa-play-circle text-white text-4xl opacity-80"></i>
                                </div>
                            {% endif %}

                            <!-- Overlay with actions -->
                            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                                <div class="flex gap-2">
                                    <a href="{{ asset('uploads/user-media/' ~ user.id ~ '/' ~ item.filename) }}"
                                       target="_blank"
                                       class="p-2 bg-white rounded-full text-gray-700 hover:bg-gray-100 transition"
                                       title="{{ 'profile.view_full_size'|trans }}">
                                        <i class="fas fa-expand"></i>
                                    </a>
                                    <button type="button"
                                            onclick="toggleVisibility({{ item.id }}, this)"
                                            class="p-2 bg-white rounded-full {{ item.isPublic ? 'text-green-600' : 'text-gray-400' }} hover:bg-gray-100 transition"
                                            title="{{ item.isPublic ? 'profile.public_click_hide'|trans : 'profile.hidden_click_show'|trans }}">
                                        <i class="fas {{ item.isPublic ? 'fa-eye' : 'fa-eye-slash' }}"></i>
                                    </button>
                                    <button type="button"
                                            onclick="deleteMedia({{ item.id }})"
                                            class="p-2 bg-white rounded-full text-red-600 hover:bg-red-50 transition"
                                            title="{{ 'profile.delete'|trans }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- File info -->
                            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-2 opacity-0 group-hover:opacity-100 transition">
                                <p class="text-white text-xs truncate">{{ item.originalFilename }}</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-16">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-images text-4xl text-gray-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ 'profile.no_media_title'|trans }}</h3>
                    <p class="text-gray-600 mb-4">{{ 'profile.no_media_description'|trans }}</p>
                    <label class="inline-block px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition cursor-pointer">
                        <i class="fas fa-upload mr-2"></i>{{ 'profile.upload_first_file'|trans }}
                        <input type="file" id="media-upload-empty" accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/webm" multiple class="hidden">
                    </label>
                </div>
            {% endif %}
        </div>

        <!-- Info Box -->
        <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex">
                <i class="fas fa-info-circle text-blue-600 mt-0.5 mr-3"></i>
                <div class="text-sm text-blue-800">
                    <strong>{{ 'profile.supported_formats'|trans }}</strong> {{ 'profile.formats_list'|trans }}<br>
                    <strong>{{ 'profile.maximum_file_size'|trans }}</strong> {{ (maxMediaSizeKb / 1024)|round(1) }}MB<br>
                    <strong>{{ 'profile.storage_limit'|trans }}</strong> {{ maxMediaPerUser }} {{ 'profile.files_per_user'|trans }}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-gray-900 mb-4">{{ 'profile.delete_media'|trans }}</h3>
        <p class="text-gray-600 mb-6">{{ 'profile.delete_media_confirm'|trans }}</p>
        <div class="flex gap-3">
            <button type="button" onclick="closeDeleteModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                {{ 'profile.cancel'|trans }}
            </button>
            <button type="button" id="confirmDeleteBtn" class="flex-1 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                {{ 'profile.delete'|trans }}
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        const maxMediaPerUser = {{ maxMediaPerUser }};
        const maxMediaSizeKb = {{ maxMediaSizeKb }};
        let currentMediaCount = {{ currentMediaCount }};
        let deleteMediaId = null;

        // Handle file upload
        function setupUploadHandler(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            input.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                const progressDiv = document.getElementById('upload-progress');
                const errorDiv = document.getElementById('upload-error');
                const uploadBar = document.getElementById('upload-bar');

                progressDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');

                let uploaded = 0;
                const total = files.length;

                for (const file of files) {
                    // Check if we can upload more
                    if (currentMediaCount >= maxMediaPerUser) {
                        showError('{{ 'profile.max_files_reached'|trans|e('js') }}');
                        break;
                    }

                    // Check file size
                    if (file.size > maxMediaSizeKb * 1024) {
                        showError('{{ 'profile.file_size_exceeded'|trans({'%size%': (maxMediaSizeKb / 1024)|round(1)})|e('js') }}');
                        continue;
                    }

                    const formData = new FormData();
                    formData.append('media', file);

                    try {
                        const response = await fetch('{{ path('app_profile_media_gallery_upload') }}', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            uploaded++;
                            currentMediaCount++;
                            uploadBar.style.width = `${(uploaded / total) * 100}%`;

                            // Add the new media to the grid
                            addMediaToGrid(result);
                        } else {
                            showError(result.error);
                        }
                    } catch (error) {
                        showError('{{ 'profile.upload_failed'|trans|e('js') }}');
                    }
                }

                setTimeout(() => {
                    progressDiv.classList.add('hidden');
                    uploadBar.style.width = '0%';
                    input.value = '';

                    // Refresh the page to update the count
                    if (uploaded > 0) {
                        location.reload();
                    }
                }, 1000);
            });
        }

        setupUploadHandler('media-upload');
        setupUploadHandler('media-upload-empty');

        function showError(message) {
            const errorDiv = document.getElementById('upload-error');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function addMediaToGrid(data) {
            const grid = document.getElementById('media-grid');
            if (!grid) {
                // Reload if grid doesn't exist (empty state)
                location.reload();
                return;
            }

            const item = document.createElement('div');
            item.className = 'media-item relative group aspect-square rounded-lg overflow-hidden bg-gray-100';
            item.dataset.id = data.id;

            const isVideo = data.type === 'video';

            item.innerHTML = `
                ${isVideo
                    ? `<video src="${data.url}" class="w-full h-full object-cover"></video>
                       <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                           <i class="fas fa-play-circle text-white text-4xl opacity-80"></i>
                       </div>`
                    : `<img src="${data.url}" class="w-full h-full object-cover">`
                }
                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                    <div class="flex gap-2">
                        <a href="${data.url}" target="_blank" class="p-2 bg-white rounded-full text-gray-700 hover:bg-gray-100 transition" title="View Full Size">
                            <i class="fas fa-expand"></i>
                        </a>
                        <button type="button" onclick="toggleVisibility(${data.id}, this)" class="p-2 bg-white rounded-full text-green-600 hover:bg-gray-100 transition" title="Public - Click to hide">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" onclick="deleteMedia(${data.id})" class="p-2 bg-white rounded-full text-red-600 hover:bg-red-50 transition" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            grid.insertBefore(item, grid.firstChild);
        }

        function deleteMedia(id) {
            deleteMediaId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            deleteMediaId = null;
            document.getElementById('deleteModal').classList.add('hidden');
        }

        document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
            if (!deleteMediaId) return;

            try {
                const response = await fetch(`/profile/media-gallery/delete/${deleteMediaId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    // Remove the item from the grid
                    const item = document.querySelector(`.media-item[data-id="${deleteMediaId}"]`);
                    if (item) {
                        item.remove();
                    }
                    currentMediaCount--;
                    closeDeleteModal();

                    // Show empty state if no more media
                    if (currentMediaCount === 0) {
                        location.reload();
                    }
                } else {
                    alert(result.error);
                }
            } catch (error) {
                alert('{{ 'profile.delete_failed'|trans|e('js') }}');
            }
        });

        async function toggleVisibility(id, btn) {
            try {
                const response = await fetch(`/api/profile/toggle-media-visibility/${id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const result = await response.json();
                    const icon = btn.querySelector('i');
                    if (result.isPublic) {
                        btn.classList.remove('text-gray-400');
                        btn.classList.add('text-green-600');
                        icon.classList.remove('fa-eye-slash');
                        icon.classList.add('fa-eye');
                        btn.title = 'Public - Click to hide';
                    } else {
                        btn.classList.remove('text-green-600');
                        btn.classList.add('text-gray-400');
                        icon.classList.remove('fa-eye');
                        icon.classList.add('fa-eye-slash');
                        btn.title = 'Hidden - Click to show';
                    }
                }
            } catch (error) {
                console.error('Error toggling visibility:', error);
            }
        }

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDeleteModal();
            }
        });

        // Close modal on backdrop click
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });
    </script>
{% endblock %}
